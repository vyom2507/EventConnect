"use strict";(()=>{var e={};e.id=523,e.ids=[523],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},92512:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>y,requestAsyncStorage:()=>_,routeModule:()=>w,serverHooks:()=>I,staticGenerationAsyncStorage:()=>v});var a={};r.r(a),r.d(a,{POST:()=>h});var s=r(49303),i=r(88716),n=r(60670),o=r(87070),d=r(83493),u=r(90455),p=r(91988);let c=process.env.STRIPE_SECRET_KEY,l=process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000",m=c?new p.Z(c,{apiVersion:"2024-06-20"}):null;async function h(e){let t=await (0,u.V)();if(!t)return new o.NextResponse("Unauthorized",{status:401});let{productId:r,paymentMethod:a}=await e.json();if(!r||!a)return new o.NextResponse("Missing productId or paymentMethod",{status:400});if(!["card","in_person"].includes(a))return new o.NextResponse("Invalid payment method",{status:400});let s=await d._.product.findUnique({where:{id:r}});if(!s||!s.isActive)return new o.NextResponse("Product not available",{status:400});if(s.ownerId===t.id)return new o.NextResponse("You cannot purchase your own listing",{status:400});let i=null;if("card"===a){if(!m)return new o.NextResponse("Stripe is not configured. Set STRIPE_SECRET_KEY.",{status:500});i=(await m.checkout.sessions.create({mode:"payment",payment_method_types:["card"],line_items:[{price_data:{currency:"usd",unit_amount:s.priceCents,product_data:{name:s.title,description:s.description}},quantity:1}],success_url:`${l}/marketplace/success?session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${l}/marketplace/${s.id}`,metadata:{productId:s.id,buyerId:t.id}})).id}let n=await d._.order.create({data:{productId:s.id,buyerId:t.id,paymentMethod:a,status:"card"===a?"paid":"created",stripeSessionId:i||void 0}});await d._.product.update({where:{id:s.id},data:{isActive:!1,soldAt:new Date}});let p=await d._.marketplaceConversation.create({data:{orderId:n.id,buyerId:t.id,sellerId:s.ownerId,messages:{create:{senderId:t.id,content:"card"===a?"Hi, I just purchased this item via card. When can we arrange delivery/pickup?":"Hi, I reserved this item for in-person payment. When and where can we meet on campus?"}}}});if("card"===a&&i){let e=await m.checkout.sessions.retrieve(i);return o.NextResponse.json({checkoutUrl:e.url,orderId:n.id,conversationId:p.id})}return o.NextResponse.json({orderId:n.id,conversationId:p.id})}let w=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/marketplace/purchase/route",pathname:"/api/marketplace/purchase",filename:"route",bundlePath:"app/api/marketplace/purchase/route"},resolvedPagePath:"C:\\Users\\vyoml\\iit-international-student-dashboard-main\\app\\api\\marketplace\\purchase\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:v,serverHooks:I}=w,x="/api/marketplace/purchase/route";function y(){return(0,n.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:v})}},90455:(e,t,r)=>{r.d(t,{V:()=>a});async function a(){try{let e=await fetch(`${process.env.NEXT_PUBLIC_APP_URL??""}/api/auth/me`,{cache:"no-store"});if(!e.ok)return null;return(await e.json()).student??null}catch(e){return console.error("getCurrentStudent error:",e),null}}},83493:(e,t,r)=>{r.d(t,{_:()=>s});let a=require("@prisma/client"),s=globalThis.prisma??new a.PrismaClient({log:["error","warn"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,5972,1988],()=>r(92512));module.exports=a})();